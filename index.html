<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Support System</title>
    <link rel="stylesheet" href="./styles.css" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://aauekpoma.edu.ng/wp-content/themes/aaue/assets/images/favicon.ico"
    />
    <style>
      .valid {
        color: green;
      }
      .invalid {
        color: red;
        align-self: start;
      }
      .message {
        padding: 0%;
        display: none;
        font-size: small;
        margin: -20px 0 0;
        align-self: flex-start;
      }
      .preview-container img {
        width: 100px;
        height: auto;
        margin: 5px;
      }
      .remove-btn:hover {
        display: block;
      }
      .remove-btn {
        display: none;
        margin-top: 5px;
        color: red;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <main class="div-rapid">
      <section class="support-container">
        <h1>Contact Support</h1>
        <form
          id="supportForm"
          action="/submit_support_request"
          method="post"
          enctype="multipart/form-data"
        >
          <label for="name">Name:</label>
          <input type="text" id="name" name="name" required />
          <div id="nameMessage" class="message">
            <p id="nameLength" class="invalid">Minimum 4 characters</p>
          </div>

          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
          <div id="emailMessage" class="message">
            <p id="emailFormat" class="invalid">Valid email format</p>
          </div>

          <label for="subject">Subject:</label>
          <input type="text" id="subject" name="subject" required />
          <div id="subjectMessage" class="message">
            <p id="subjectLength" class="invalid">Minimum 5 characters</p>
          </div>

          <label for="message">Message:</label>
          <textarea id="message" name="message" rows="5" required></textarea>
          <div id="textMessage" class="message">
            <p id="messageLength" class="invalid">Minimum 10 characters</p>
          </div>

          <label for="file">File:</label>
          <input
            type="file"
            id="file"
            name="file[]"
            accept=".jpg,.jpeg,.png"
            multiple
            required
          />
          <div id="fileMessage" class="message">
            <p id="fileNumber" class="invalid">Upload 1 to 4 images</p>
            <p id="fileType" class="invalid">
              File must be an image (jpg, jpeg, png)
            </p>
            <p id="fileSize" class="invalid">
              Each file size must be less than 2MB
            </p>
          </div>
          <div class="preview-container" id="previewContainer"></div>

          <button type="submit">Submit</button>
        </form>
      </section>
    </main>

    <script>
      "use strict";

      // Function to add validation to input fields
      function addValidation(inputId, messageId, validations) {
        const input = document.getElementById(inputId);
        const message = document.getElementById(messageId);

        input.addEventListener("change", function () {
          validateInput(input, message, validations);
        });
      }

      // Function to validate input
      function validateInput(input, message, validations) {
        let isValid = true;
        validations.forEach((validation) => {
          const { condition, elementId, validClass, invalidClass } = validation;
          const element = document.getElementById(elementId);
          if (!condition(input)) {
            element.classList.remove(validClass);
            element.classList.add(invalidClass);
            isValid = false;
          } else {
            element.classList.remove(invalidClass);
            element.classList.add(validClass);
          }
        });

        if (isValid) {
          message.style.display = "none";
        } else {
          message.style.display = "block";
        }
      }

      // Function to preview images
      function previewImages(input, previewContainerId) {
        const previewContainer = document.getElementById(previewContainerId);
        previewContainer.innerHTML = ""; // Clear existing previews

        Array.from(input.files).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const imgContainer = document.createElement("div");
            imgContainer.style.position = "relative";

            const img = document.createElement("img");
            img.src = e.target.result;
            imgContainer.appendChild(img);

            const removeBtn = document.createElement("span");
            removeBtn.textContent = "Remove";
            removeBtn.classList.add("remove-btn");
            removeBtn.dataset.index = index;
            imgContainer.appendChild(removeBtn);

            previewContainer.appendChild(imgContainer);
          };
          reader.readAsDataURL(file);
        });
      }

      // Remove image function
      function removeImage(index) {
        const fileInput = document.getElementById("file");
        const dt = new DataTransfer();
        const files = Array.from(fileInput.files);

        files.forEach((file, i) => {
          if (i !== index) {
            dt.items.add(file);
          }
        });

        fileInput.files = dt.files;
        previewImages(fileInput, "previewContainer");
      }

      // File field validations and preview
      const fileInput = document.getElementById("file");
      fileInput.addEventListener("change", function () {
        previewImages(fileInput, "previewContainer");
      });

      document
        .getElementById("previewContainer")
        .addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-btn")) {
            const index = e.target.dataset.index;
            removeImage(parseInt(index));
          }
        });

      addValidation("file", "fileMessage", [
        {
          condition: (input) =>
            input.files.length >= 1 && input.files.length <= 4,
          elementId: "fileNumber",
          validClass: "valid",
          invalidClass: "invalid",
        },
        {
          condition: (input) =>
            Array.from(input.files).every((file) =>
              ["image/jpeg", "image/png", "image/jpg"].includes(file.type)
            ),
          elementId: "fileType",
          validClass: "valid",
          invalidClass: "invalid",
        },
        {
          condition: (input) =>
            Array.from(input.files).every(
              (file) => file.size <= 2 * 1024 * 1024
            ), // 2MB
          elementId: "fileSize",
          validClass: "valid",
          invalidClass: "invalid",
        },
      ]);

      // Name field validations
      addValidation("name", "nameMessage", [
        {
          condition: (input) => input.value.length >= 4,
          elementId: "nameLength",
          validClass: "valid",
          invalidClass: "invalid",
        },
      ]);

      // Email field validations
      addValidation("email", "emailMessage", [
        {
          condition: (input) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value),
          elementId: "emailFormat",
          validClass: "valid",
          invalidClass: "invalid",
        },
      ]);

      // Subject field validations
      addValidation("subject", "subjectMessage", [
        {
          condition: (input) => input.value.length >= 5,
          elementId: "subjectLength",
          validClass: "valid",
          invalidClass: "invalid",
        },
      ]);

      // Message field validations
      addValidation("message", "textMessage", [
        {
          condition: (input) => input.value.length >= 10,
          elementId: "messageLength",
          validClass: "valid",
          invalidClass: "invalid",
        },
      ]);
    </script>
  </body>
</html>
